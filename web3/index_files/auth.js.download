var Auth={data:{domain:window.location.host,api_domain:undefined,frontend_app_sso_login:undefined,section:0,mobile:undefined,captcha:undefined,captcha_key:undefined,code:undefined,firstname:undefined,lastname:undefined,email:undefined,avatar:undefined,timer_interval:undefined,dictionary:{success:'موفق',error:'خطا',wrong_mobile:'شماره موبایل وارد شده صحیح نمی‌باشد',wrong_captcha:'کد کپچا وارد شده اشتباه می باشد',otp_send_error:'خطا در ارسال کد یکبار مصرف',otp_sent:'لطفا کد ارسال شده را در کادر مربوطه وارد نمایید',otp_error:'کد یکبار مصرف اشتباه است',logged_in:'ورود با موفقیت انجام شد',register:'لطفا مشخصات خود را برای تکمیل مراحل عضویت وارد نمایید',email_or_mobile_exists:'شماره موبایل یا آدرس ایمیل وارد شده از پیش ثبت شده است',email_exists:'آدرس ایمیل وارد شده از پیش ثبت شده است',mobile_exists:'شماره موبایل وارد شده از پیش ثبت شده است',username_exists:'نام کاربری وارد شده از پیش ثبت شده است',register_error:'خطا در عضویت. لطفا مجدد تلاش کنید',email_format_error:'ایمیل وارد شده صحیح نمی‌باشد',username_format_error:'برای انتخاب نام کاربری لطفا فقط از حروف انگلیسی، اعداد و زیرخط استفاده کنید',field_empty:'لطفا تمامی فیلدها را وارد نمایید',user_banned:'کاربر گرامی ، متاسفانه اکانت شما مسدود شده است . از طریق پشتیبانی اقدام نمایید . ',term_required:'لطفا ابتدا قوانین سایت را مطالعه و تایید نمایید.',}},set_api_domain:function(url){this.data.api_domain=url;},set_frontend_app_sso_login:function(status){this.data.frontend_app_sso_login=status;},load:function(){var self=this;if(!document.getElementById('auth-modal-box'))
{$('head').append('<link rel="stylesheet" href="https://static.tgju.org/views/default/css/auth.css?37" type="text/css" />');$('head').append('<link rel="stylesheet" href="https://static.tgju.org/views/default/js/intl-tel-input-master/build/css/intlTelInput.css?07" type="text/css" />');$.getScript("https://cdn.rtlcss.com/bootstrap/v4.2.1/js/bootstrap.min.js");$.getScript("https://unpkg.com/sweetalert/dist/sweetalert.min.js");$.getScript("https://static.tgju.org/views/default/js/intl-tel-input-master/build/js/intlTelInput.js").done(function(){var check_auth_input=setInterval(function(){if($('#auth-phone').length){clearInterval(check_auth_input);self.mobile_validation();}},100);});var html='<div id="auth-modal-box" class="auth-modal-box show">';html+='<div class="auth-modal-box-bg" onclick="Auth.close();"></div>';html+='<div class="auth-inner">';html+='<div class="auth-body">';html+='<div class="auth-body-inner">';html+='<div class="auth-header">';html+='<div class="auth-logo">';html+='<img src="https://static.tgju.org/views/default/images/auth-tgju-logo.png" alt="TGJU">';html+='</div>';html+='</div>';html+='<div class="auth-sections">';html+='<section class="auth-section init-section" data-submit="init">';html+='<label>';html+='<span class="auth-input-title">لطفا شماره همراه خود را وارد نمایید</span>';html+='<div class="auth-phone-box"><input data-auth="mobile" type="tel" id="auth-phone" maxlength="11" class="form-control mobile_number" style="direction: ltr;">';html+='<span id="auth-phone-validation"></span></div>';html+='</label>';html+='<div class="capbox">';html+='<div class="capbox-image">';html+='<div id="captcha-div"></div>';html+='<i class="fa fa-refresh" style="font-size:20px;" onclick="Auth.captcha();"></i>';html+='</div>';html+='<div class="capbox-inner">';html+='<input type="text" name="CaptchaInput" id="captcha-input" placeholder="کد بالا را در این کادر بنویسید" size="15">';html+='</div>';html+='</div>';html+='</section>';html+='<section class="auth-section" style="display: none;" data-submit="otp">';html+='<div class="alert alert-success">لطفا کد یکبار مصرف ارسال شده به موبایل خود را وارد نمایید.</div>';html+='<label>';html+='<span class="auth-input-title">کد تایید</span>';html+='<input data-auth="code" type="tel" class="form-control text-center auth-input code" maxlength="6" style="direction: ltr;">';html+='</label>';html+='<div class="auth-timer-box">';html+='<div class="auth-timer-title">زمان مجاز</div>';html+='<div class="auth-timer">';html+='<span id="auth-time">02:00</span> دقیقه';html+='</div>';html+='</div>';html+='<div id="auth-send-code">';html+='<p>اتمام زمان مجاز</p>';html+='<button type="button" class="auth-modal-btn danger" onclick="Auth.reset_timer();">ارسال مجدد</button>';html+='</div>';html+='</section>';html+='<section class="auth-section" style="display: none;" data-submit="register">';html+='<div class="alert alert-success">لطفا مشخصات خود را در جهت عضویت اولیه در سامانه وارد نمایید.</div>';html+='<div class="row-items">';html+='<label class="row-item-1">';html+='<span>نام:</span>';html+='<input data-auth="firstname" type="text" class="form-control auth-input">';html+='</label>';html+='<label class="row-item-2">';html+='<span>نام خانوادگی:</span>';html+='<input data-auth="lastname" type="text" class="form-control auth-input">';html+='</label>';html+='</div>';html+='<label>';html+='<span>نام کاربری:</span>';html+='<div class="small text-muted">فقط کاراکترهای انگلیسی، اعداد و زیرخط</div>';html+='<input data-auth="username" type="text" class="form-control auth-input" style="direction: ltr">';html+='</label>';html+='<label>';html+='<span>ایمیل:</span>';html+='<input data-auth="email" type="email" class="form-control auth-input" style="direction: ltr">';html+='</label>';html+='<label class="auth-terms">';html+='<input data-auth="terms" type="checkbox" class="form-control auth-terms term-checkbox" style="direction: ltr">';html+='<span><a href="https://www.tgju.org/terms" target="_blank">قوانین و شرایط استفاده</a> را خوانده‌ام و با آن موافقم.</span>';html+='</label>';html+='</section>';html+='</div>';html+='<div class="auth-footer">';html+='<button type="button" class="auth-modal-btn auth-submit" onclick="Auth.submit();" style="float: right;">تایید</button>';html+='<div class="flex-grow-1" style="display: none;"></div>';html+='<button type="button" class="auth-modal-btn warning auth-change-number" style="display: none;" onclick="Auth.init_page();">تغییر شماره</button>';html+='</div>';html+='<div class="auth-loading">';html+='<div class="auth-loading-s" style="height: 26px; width: 26px;">';html+='<svg height="100%" viewBox="0 0 32 32" width="100%"><circle cx="16" cy="16" fill="none" r="14" stroke-width="4" style="stroke: rgb(29, 155, 240); opacity: 0.2;"></circle><circle cx="16" cy="16" fill="none" r="14" stroke-width="4" style="stroke: rgb(29, 155, 240); stroke-dasharray: 80; stroke-dashoffset: 60;"></circle></svg>';html+='</div>';html+='</div> ';html+='</div>';html+='</div>';html+='<div class="auth-cover"></div> ';html+='<button type="button" class="auth-modal-close" onclick="Auth.close();">✖</button>';html+='</div>';html+='</div>';$('body').append(html);}else{var auth_modal=document.querySelector(".auth-modal-box");auth_modal.classList.add("show");}
self.captcha();},mobile_validation:function(){var input=document.querySelector("#auth-phone"),validMsg=document.querySelector("#auth-phone-validation");var MsgMap;var validMsgContent;var iti=window.intlTelInput(input,{initialCountry:"ir",utilsScript:"https://static.tgju.org/views/default/js/intl-tel-input-master/build/js/utils.js",});var mobile_validation_set_country=function(){if(iti.getSelectedCountryData().iso2=="ir"){MsgMap=["✖","✖","✖","✖","✖"];validMsgContent="✓";validMsg.classList.remove("auth-validation-ltr");}else{MsgMap=["✖","✖","✖","✖","✖"];validMsgContent="✓";validMsg.classList.add("auth-validation-ltr");}};mobile_validation_set_country();var mobile_validation_reset=function(){validMsg.classList.remove("auth-number-error");validMsg.classList.remove("auth-number-valid");validMsg.innerHTML="";mobile_validation_set_country();};input.addEventListener('blur',function(){mobile_validation_reset();if(input.value.trim()){if(iti.isValidNumber()){validMsg.innerHTML=validMsgContent;validMsg.classList.add("auth-number-valid");validMsg.classList.remove("auth-number-error");}else{var errorCode=iti.getValidationError();validMsg.innerHTML=MsgMap[errorCode];validMsg.classList.add("auth-number-error");validMsg.classList.remove("auth-number-valid");}}});input.addEventListener('change',mobile_validation_reset);input.addEventListener('keyup',mobile_validation_reset);},show:function(){$('.auth-submit').prop('disabled',false);var auth_modal=document.querySelector(".auth-modal-box");auth_modal.classList.add("show");document.getElementsByTagName("html")[0].classList.add('show-auth-modal');},close:function(){var auth_modal=document.querySelector(".auth-modal-box");auth_modal.classList.remove("show");document.getElementsByTagName("html")[0].classList.remove('show-auth-modal');},submit:function(){var method=$('.auth-section:visible').attr('data-submit');$('.auth-submit').prop('disabled',true);if(method=='init'){$('[data-auth="code"]').val('');var auth_modal=document.querySelector("#auth-send-code");auth_modal.classList.remove("show");}
Auth[method]();},init_page:function(){$('.auth-submit').prop('disabled',false);$('.auth-section').hide();$('.init-section').show();$('.auth-change-number').hide();$('.flex-grow-1').hide();this.data.section=0;},slide:function(idx){if(typeof idx==='number'){$('.auth-section').hide();$('.auth-section').eq(idx).show();$('.auth-change-number').show();$('.flex-grow-1').show();this.data.section=idx;}else if($('.auth-section:visible:last-child').html()===undefined){$('.auth-section').hide();$('.auth-change-number').show();$('.flex-grow-1').show();$('.auth-section').eq(++this.data.section).show();}},captcha:function(){$.ajax({url:'https://dashboard-api.accessban.com/captcha/api/flat',method:'get',complete:function(res){var captchaImage='<img src='+res.responseJSON.img+' />';captchaImage+='<input type="hidden" id="captcha-key" name="key" value='+res.responseJSON.key+' />';$("#captcha-div").html(captchaImage);}});},init:function(reset_code){var self=this;this.mobile=$('[data-auth="mobile"]').val();this.captcha=$('#captcha-input').val();this.captcha_key=$('#captcha-key').val();var auth_modal=document.querySelector(".auth-loading");auth_modal.classList.add("show");var demo_mobile=this.mobile;$.ajax({url:this.data.api_domain+'/v1/auth/init',method:'post',data:{mobile:this.mobile,captcha:this.captcha,key:this.captcha_key,},complete:function(res){auth_modal.classList.remove("show");if(res.responseJSON.status==='error'){swal({title:self.data.dictionary[res.responseJSON.status],text:self.data.dictionary[res.responseJSON.message],icon:res.responseJSON.status,button:"باشه",});}else{if(res.responseJSON.message==='demo'){$.ajax({url:'https://dashboard-api.tgju.org/v1/auth/otp',method:'post',data:{mobile:demo_mobile,code:'0',domain:'tgju.org'},complete:function(res){auth_modal.classList.remove("show");if(res.responseJSON.status!=='success'){swal({title:self.data.dictionary[res.responseJSON.status],text:self.data.dictionary[res.responseJSON.message],icon:res.responseJSON.status,button:"باشه",});}else{if(res.responseJSON.message==='wrong_captcha'){swal({title:this.data.dictionary['error'],text:this.data.dictionary[res.responseJSON.message],icon:"error",button:"باشه",});}
if(res.responseJSON.message==='register'){self.slide();self.slide();}
if(res.responseJSON.message==='logged_in'&&res.responseJSON.hasOwnProperty('token')){self.login(res.responseJSON);self.close();}}}});}else{self.set_timer();if(!reset_code){self.slide();}}}
$('.auth-submit').prop('disabled',false);}});},otp:function(){var self=this;this.code=$('[data-auth="code"]').val();if(this.code.length<6){swal({title:"خطا",text:'تعداد رقم‌های کد تایید وارد شده کمتر از 6 عدد می باشد',icon:"error",button:"باشه",});}else if(this.code===undefined||this.code===null){swal({title:"خطا",text:'عددی در قسمت کد تایید وارد نشده است',icon:"error",button:"باشه",});}else{var auth_modal=document.querySelector(".auth-loading");auth_modal.classList.add("show");$.ajax({url:this.data.api_domain+'/v1/auth/otp',method:'post',data:{mobile:this.mobile,code:this.code,domain:this.data.domain},complete:function(res){auth_modal.classList.remove("show");if(res.responseJSON.status!=='success'){swal({title:self.data.dictionary[res.responseJSON.status],text:self.data.dictionary[res.responseJSON.message],icon:res.responseJSON.status,button:"باشه",});}else{if(res.responseJSON.message==='register'){self.slide();}
if(res.responseJSON.message==='logged_in'&&res.responseJSON.hasOwnProperty('token')){self.login(res.responseJSON);self.close();}}}});}
$('.auth-submit').prop('disabled',false);},register:function(){var self=this;this.firstname=$('[data-auth="firstname"]').val();this.lastname=$('[data-auth="lastname"]').val();this.email=$('[data-auth="email"]').val();this.username=$('[data-auth="username"]').val();if($('.term-checkbox').is(':checked')){var auth_modal=document.querySelector(".auth-loading");auth_modal.classList.add("show");$.ajax({url:this.data.api_domain+'/v1/auth/register',method:'post',data:{mobile:this.mobile,code:this.code,firstname:this.firstname,lastname:this.lastname,email:this.email,username:this.username,domain:this.data.domain},complete:function(res){$('.auth-submit').prop('disabled',false);auth_modal.classList.remove("show");if(res.responseJSON.status!=='success'){swal({title:self.data.dictionary[res.responseJSON.status],text:self.data.dictionary[res.responseJSON.message],icon:res.responseJSON.status,button:"باشه",});}
if(res.responseJSON.message==='logged_in'&&res.responseJSON.hasOwnProperty('token')){self.login(res.responseJSON);self.close();}}});}else{swal({title:this.data.dictionary['error'],text:this.data.dictionary['term_required'],icon:"error",button:"باشه",});$('.auth-submit').prop('disabled',false);}},login:function(res){if(res.sso&&res.token){var url=res.sso.endpoint+'?token='+res.token;if(window.location.href.indexOf('popup=true')!==-1){url+='&popup=true';}
!this.data.frontend_app_sso_login?$('body').append('<iframe style="display: none;" src="'+url+'"></iframe>'):'';var auth_modal=document.querySelector(".auth-modal-box");auth_modal.classList.remove("show");this.data.frontend_app_sso_login?window.location.replace(url):'';}},start_timer:function(duration,display){timer=duration;var minutes,seconds;Auth.data.timer_interval=setInterval(function(){minutes=parseInt(timer/60,10)
seconds=parseInt(timer%60,10);minutes=minutes<10?"0"+minutes:minutes;seconds=seconds<10?"0"+seconds:seconds;display.textContent=minutes+":"+seconds;if(--timer<0){timer=0;var auth_modal=document.querySelector("#auth-send-code");auth_modal.classList.add("show");clearInterval(Auth.data.timer_interval);}},1000);},reset_timer:function(){var auth_modal=document.querySelector("#auth-send-code");auth_modal.classList.remove("show");timer_set=60*2;this.init(true);},set_timer:function(){clearInterval(Auth.data.timer_interval);timer_set=60*2;display=document.querySelector('#auth-time');this.start_timer(timer_set,display);}};